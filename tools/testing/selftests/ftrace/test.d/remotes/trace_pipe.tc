#!/bin/sh
# SPDX-License-Identifier: GPL-2.0
# description: Test trace remote trace_pipe

. $TEST_DIR/remotes/functions

test_trace_pipe()
{
    echo 0 > tracing_on
    assert_unloaded

    echo 1024 > buffer_size_kb
    echo 1 > tracing_on
    assert_loaded

    output=$(mktemp /tmp/remote_test.XXXXXX)

    cat trace_pipe > $output &
    pid=$!

    for i in $(seq 1 1000); do
        echo $i > write_event
    done

    echo 0 > tracing_on
    sleep 1
    kill $pid

    prev_ts=0 # TODO: Init with proper clock value
    prev_id=0

    # Only keep <timestamp> <id>
    sed -i -e 's/\[[0-9]*\]\s*\([0-9]*.[0-9]*\): [a-z]* id=\([0-9]*\)/\1 \2/' $output

    IFS=$'\n'
    for line in $(cat $output); do
        ts=$(echo $line | cut -d ' ' -f 1)
        id=$(echo $line | cut -d ' ' -f 2)

        test $(echo "$ts>$prev_ts" | bc) -eq 1
        test $id -eq $((prev_id + 1))

        prev_ts=$ts
        prev_id=$id
    done

    test $prev_id -eq 1000

    rm $output
}

if [ -z "$SOURCE_REMOTE_TEST" ]; then
    set -e

    setup_remote_test
    test_trace_pipe
fi
